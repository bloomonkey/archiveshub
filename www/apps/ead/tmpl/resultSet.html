<%!
    # Imports
    from cheshire3.utils import flattenTexts
    from cheshire3archives.apps.ead.base import namespaceUriHash
%>

<%def name="back_links(resultSet, maximumRecords, startRecord)">
    <a href="search.html?rsid=${resultSet.id|u}&amp;startRecord=1&amp;maximumRecords=${maximumRecords}#leftcol"
      class="ajax">
        <img src="${config.get('icons', 'fast-rewind-url')}" alt="|&lt;&lt;">
    </a>
    <a href="search.html?rsid=${resultSet.id|u}&amp;startRecord=${max(startRecord - maximumRecords, 1)}&amp;maximumRecords=${maximumRecords}&amp;#leftcol"
      class="ajax">
        <img src="${config.get('icons', 'rewind-url')}" alt="&lt;&lt;">
    </a>
</%def>

<%def name="forward_links(resultSet, maximumRecords, startRecord)">
    <a href="search.html?rsid=${resultSet.id|u}&amp;startRecord=${min(startRecord + maximumRecords, len(resultSet))}&amp;maximumRecords=${maximumRecords}&amp;#leftcol"
      class="ajax">
        <img src="${config.get('icons', 'forward-url')}" alt="&gt;&gt;">
    </a>
    <a href="search.html?rsid=${resultSet.id|u}&amp;startRecord=${((len(resultSet) / maximumRecords) * maximumRecords) + 1}&amp;maximumRecords=${maximumRecords}#leftcol"
      class="ajax">
        <img src="${config.get('icons', 'fast-forward-url')}" alt="&gt;&gt;|">
    </a>
</%def>

<%def name="displaying(resultSet, sortBy, maximumRecords, startRecord)">
    <div class="displaying">
        Displaying <strong>${startRecord}</strong>
        to <strong>${min(startRecord + maximumRecords - 1, len(resultSet))}</strong>
        of ${len(resultSet)}.
    </div>
</%def>

<%def name="sortBySelect(resultSet, sortBy, maximumRecords, startRecord)">
    <div class="sortBy">
        <form action="search.html">
            <input type="hidden" name="rsid" value="${resultSet.id}"/>
            <select name="sortBy">
                % for val, label in [('weight', 'Relevance'), ('/*/*/did/unittitle/text()', 'Title')]:
                    % if val in sortBy:
                    <option value="${val}" selected="selected">${label}</option>
                    % else:
                    <option value="${val}">${label}</option>
                    % endif
                    
                % endfor
            </select>
        </form>
    </div>
</%def>

<%def name="maximumRecordsSelect(resultSet, sortBy, maximumRecords, startRecord)">
    <div class="maximumRecords">
        <a 
            href="search.html?rsid=${resultSet.id|u}&amp;startRecord=${startRecord}&amp;maximumRecords=20#leftcol"
            class="ajax maximumRecords">
            20
        </a>
        % if len(resultSet) >= 100:
            <a 
                href="search.html?rsid=${resultSet.id|u}&amp;startRecord=${startRecord}&amp;maximumRecords=50#leftcol"
                class="ajax maximumRecords">
                50
            </a>
        % endif
        % if len(resultSet) >= 200:
            <a 
                href="search.html?rsid=${resultSet.id|u}&amp;startRecord=${startRecord}&amp;maximumRecords=100#leftcol"
                class="ajax maximumRecords">
                100
            </a>
        % endif
        <a 
            href="search.html?rsid=${resultSet.id|u}&amp;startRecord=${startRecord}&amp;maximumRecords=${len(resultSet)}#leftcol"
            class="ajax maximumRecords">
            all
        </a>
    </div>
</%def>

<%def name="dataFromRecordXpaths(session, rec, xps, nTerms=1, joiner=u'; ')">
    <%
    # Extract data from record by XPaths in priority order provided in xps.
    data = []
    for xp in xps:
        data.extend(rec.process_xpath(session, xp, namespaceUriHash))
        if len(data) >= nTerms:
            break
    return joiner.join([flattenTexts(d) for d in data[:nTerms]])
    %>
</%def>

<%def name="format_resultSetItem(resultSet, sortBy, maximumRecords, startRecord, index)">
    <td>
    <%
    rec = resultSet[index].fetch_record(session)
    %>
    ## Check for potential component-level record
    % try:
        <%
        parentId = rec.process_xpath(session,
                                     '/c3component/@parent')[0]
        %>
        ## OK, must be a component record
        <img src="img/folderOpen.gif" alt="|/`/"/>
    % except IndexError:
        ## Collection level
    % endtry
    <%
    title = dataFromRecordXpaths(session, rec, ['/*/*/did/unittitle', '/ead/eadheader/filedesc/titlestmt/titleproper'], nTerms=1, joiner=u'; ')
    date = dataFromRecordXpaths(session, rec, ['/*/*/did/unitdate', '/*/*/did/unittitle/unitdate'], nTerms=1, joiner=u'; ')
    %>
    <a \
        href="summary.html?rsid=${resultSet.id}&amp;hit=${index}&amp;startRecord=${startRecord}&amp;maximumRecords=${maximumRecords}">
        ${title}
    </a>
    <br/>
    ${date}
    ## Relevance
    </td>
</%def>
