<config>

<!-- 
	This file was produced, and released as part of Cheshire for Archives v3.x.
	Copyright &copy; 2005-2007 the University of Liverpool
 -->
 
  <subConfigs>

	<subConfig type="workflow" id="preParserWorkflow">
      <objectType>workflow.CachingWorkflow</objectType>
      <workflow>
        <!-- input type:  document -->
        <object type="preParser" ref="PrintableOnlyPreParser"/>
        <object type="preParser" ref="CharacterEntityPreParser"/>
        <object type="preParser" ref="eadSgmlPreParser"/>
        <object type="preParser" ref="emptyEmphTagStripPreParser"/>
        <object type="preParser" ref="AmpPreParser"/>
      </workflow>
    </subConfig>
    
    
    <subConfig type="workflow" id="buildIndexWorkflow">
      <objectType>workflow.CachingWorkflow</objectType>
      <workflow>
        <!-- input type:  documentFactory -->
        <log>"Loading records"</log>
        <object type="recordStore" ref="recordStore" function="begin_storing"/>
        <object type="recordStore" ref="eadDcStore" function="begin_storing"/>
        <object type="database" function="begin_indexing"/>
        <assign to="VAR_ctr" from="1"/>
        <for-each>
          <!-- input type: document -->
          <log>"... (%s)" % (VAR_ctr)</log>
          <assign to="VAR_ctr" from="VAR_ctr + 1"/>
          <object type="workflow" ref="buildIndexSingleWorkflow"/>
        </for-each>
        <object type="recordStore" ref="recordStore" function="commit_storing"/>
        <object type="recordStore" ref="eadDcStore" function="commit_storing"/>
        <object type="database" function="commit_indexing"/>
        <object type="database" function="commit_metadata"/>
        <log>Records/Indexes Loaded</log> 
      </workflow>
    </subConfig>


    <subConfig type="workflow" id="buildIndexSingleWorkflow">
      <objectType>workflow.CachingWorkflow</objectType>
      <workflow>
		<!-- input type:  document -->
		<object type="workflow" ref="preParserWorkflow"/>
		<try>
		  <object type="parser" ref="SaxParser"/>
		</try>
		<except>
	  		<log>"*** " + str(input.filename) + " unparsable: " + str(err)</log>
		  	<return/>
		</except>
		<!-- type: record -->
       	<object type="workflow" ref="indexRecordWorkflow"/>
      </workflow>
    </subConfig>
 

    <subConfig type="workflow" id="buildDcRecordWorkflow">
      <objectType>workflow.CachingWorkflow</objectType>
      <workflow>
        <!-- input type: record -->
        <assign from="input.id" to="identifier"/>
        <object type="transformer" ref="eadDublinCoreTxr"/>
        <!-- type: document -->
        <try>
          <object type="parser" ref="NsSaxParser"/>
        </try>
        <except>
			<log>"" + str(err)</log>
			<log>"" + input.get_raw()</log>
			<log>"*** " + input.id + " DC record unparsable"</log>
        </except>
        <assign from="identifier" to="input.id"/>
        <try>
          <object type="recordStore" ref="eadDcStore" function="store_record"/>
        </try>
        <except>
          <log>"*** duplicate DC record"</log>
        </except>
      </workflow>
    </subConfig>
    
    <subConfig type="workflow" id="buildAllComponentWorkflow">
    	<objectType>workflow.CachingWorkflow</objectType>
			<workflow>
				<!-- input type: recordStore -->
				<object type="database" function="begin_indexing"/>
				<object type="recordStore" ref="componentStore" function="begin_storing"/>
				<for-each>
					<object type="workflow" ref="buildComponentWorkflow"/>
				</for-each>
				<object type="recordStore" ref="componentStore" function="commit_storing"/>
				<object type="database" function="commit_indexing"/>
				<object type="database" function="commit_metadata"/>
			</workflow>
    </subConfig>


    <subConfig type="workflow" id="buildComponentWorkflow">
    	<objectType>workflow.CachingWorkflow</objectType>
    	<workflow>
    		<!-- input type: record -->
    		<assign from="input.id" to="recid" />
    		<object type="documentFactory" ref="componentDocumentFactory" function="load" />
    		<!-- type: documentFactory -->
    		<log>"Loading components from record " + recid</log>
    		<assign to="VAR_ctr" from="0" />
    		<for-each>
    			<!-- type: document -->
    			<object type="workflow" ref="preParserWorkflow"/>
    			<try>
    				<object type="parser" ref="SaxParser" />
    			</try>
    			<except>
    				<log>"*** Unparsable Components"</log>
    				<log>"" + str(err)</log>
    				<continue/>
    			</except>
    			<!-- type: record -->
    			<try>
	    			<object type="workflow" ref="assignXPathIdentifierWorkflow"/>
	    		</try>
	    		<except>
	    			<assign from="recid + '-' + str(VAR_ctr)" to="input.id" />
	    		</except>
	    		<assign from="VAR_ctr + 1" to="VAR_ctr" />
    			<try>
    				<object type="recordStore" ref="componentStore" function="store_record" />
    			</try>
    			<except>
	    			<raise/>
    				<log>"*** Component unstorable"</log>
    				<log>
    					"\n" + ''.join(traceback.format_exception(sys.exc_type,sys.exc_value,sys.exc_traceback))
    				</log>
    				<log>"" + input.get_xml()</log>
    				<continue />
    			</except>
    			<object type="database" function="add_record" />
    			<try>
    				<object type="database" function="index_record" />
    			</try>
    			<except>
    				<log>"*** Some indexes incomplete"</log>
    				<!--						<log>"\n" + ''.join(traceback.format_exception(sys.exc_type,sys.exc_value,sys.exc_traceback))</log>-->
    			</except>
    		</for-each>
    	</workflow>
    </subConfig>

	<subConfig type="workflow" id="assignXPathIdentifierWorkflow">
		<objectType>workflow.CachingWorkflow</objectType>
		<workflow>
			<!-- input type: record -->
			<!-- first put record aside so we can re-assign it later -->
			<assign from="input" to="myRecord"/>
			<!-- get space-stripped identifier, assign to input -->
			<try>
				<assign from="input.process_xpath('/ead/eadheader/eadid[1]/text()')[0]" to="input"/>
			</try>
			<except>
				<!-- component record -->
				<assign from="input.process_xpath('/c3component/@parent')[0]" to="parentid"/>
				<assign from="parentid.split('/', 1)[-1]" to="parentid"/>
				<assign from="parentid + '-' + input.process_xpath('did[1]/unitid/text()')[0]" to="input"/>
			</except>
			<object type="normaliser" ref="DiacriticNormaliser" function="process_string"/>
			<object type="normaliser" ref="CaseNormaliser" function="process_string"/>
			<object type="normaliser" ref="SpaceNormaliser" function="process_string"/>
			<assign from="input.replace(' ', '').replace('/', '-')" to="myRecord.id"/>
			<assign from="myRecord" to="input"/>
		</workflow>
	</subConfig>

    <subConfig type="workflow" id="indexRecordWorkflow">
	  <objectType>workflow.CachingWorkflow</objectType>
	  <workflow>
	    <!-- input type:  record -->
	    <!-- assign identifier -->
		<object type="workflow" ref="assignXPathIdentifierWorkflow"/>
		<object type="recordStore" function="store_record"/>
		<object type="database" function="add_record"/>
		<try>
		  <object type="database" function="index_record"/>
		  <log>"... " + input.id + " loaded, indexed"</log>	
		</try>
		<except>
		  <log>"*** " + input.id + " Some indexes incomplete"</log>
		</except>
		<object type="workflow" ref="buildDcRecordWorkflow"/>
	  </workflow>
	</subConfig>

  </subConfigs>

</config>
